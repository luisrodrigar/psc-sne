---
title: "Applications PSC-SNE"
author: "Luis Ángel Rodríguez García"
date: "27-05-2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rprojroot)
library(here)
print(here())
library(knitr)
library(rgl)
rgl::setupKnitr()
```

```{r include=FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = rprojroot::find_rstudio_root_file())
source(here('R', 'psc_sne.R'))
source(here('R', 'psc_sne.R'))
source(here('R', "perplexity.R"))
source(here('R', "low_dimension.R"))
source(here('R', "high_dimension.R"))
source(here('R', "prob_distribution.R"))
```

## Cases

### Case 1

Sample on the $(\mathbb{S}^1)^2$ where $p=1$ and $r=2$.

Data:

```{r}
# Sample on the (S^1)^2
n <- 200
set.seed(100469000)
vmf11 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_cir(th = 0)), kappa = 10)
set.seed(100469000)
vmf12 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_cir(th = pi)), kappa = 10)
x1 <- sdetorus::toPiInt(cbind(DirStats::to_rad(vmf11),
                              DirStats::to_rad(vmf12)))

set.seed(100469000)
vmf21 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_cir(th = pi / 2)), kappa = 5)
set.seed(100469000)
vmf22 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_cir(th = 0)), kappa = 5)
x2 <- sdetorus::toPiInt(cbind(DirStats::to_rad(vmf21),DirStats::to_rad(vmf22)))

```

Let's take a look to the data we have generated for the first circumference:

```{r fig.height=2, fig.width=2, fig.align='center'}
r <- 1
plot(rbind(vmf11, vmf12),
     xlim = c(-r, r), ylim = c(-r, r),
     col = rep(1:2, each = n),
     xlab = "x", ylab="y")

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, it is time to see the second circumference we have generated randomly before:

```{r fig.height=2, fig.width=2, fig.align='center'}
r <- 1
plot(rbind(vmf21, vmf22),
     xlim = c(-r, r), ylim = c(-r, r),
     col = rep(1:2, each = n),
     xlab = "x", ylab="y")

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, let's do the same visualization with the data on the torus:

```{r}
x <- rbind(x1, x2)
plot(x, xlim = c(-pi, pi), ylim = c(-pi, pi), axes = FALSE,
     col = rep(c(1, 2), each = n), pch = 16, 
     xlab = "x", ylab = "y")
sdetorus::torusAxis()

```

```{r}
# Cartesian coordinates
n <- 400
x_array <- array(dim = c(n, 2, 2))
x_array[, , 1] <- DirStats::to_cir(x[, 1])
x_array[, , 2] <- DirStats::to_cir(x[, 2])
```

Let's calculate the rho parameters based on a perplexity of 20:

```{r cache=TRUE}
# Time difference of 2.582784 mins
rho_first_20 <- rho_optim_parallel(x_array, 20)
```

First, let's reduce to dimension $\mathbb{S}^1$ then $d=1$ (circumference):

```{r cache=TRUE}
Y <- psc_sne(X=x_array, d=1, rho_psc_list = rho_first_20, num_iteration=125, colors=rep(c(1,2), each=nrow(x_array)/2), visualize_prog = TRUE)
```

```{r}
Y_rad <- DirStats::to_rad(Y[,,127])
r <- 1
theta <- Y_rad

plot(r*sin(theta),
     r*cos(theta),
     col=rep(c(1,2), each=nrow(Y)/2),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now we are going to reduce to dimension $\mathbb{S}^2$ then $d=2$ (sphere):

```{r cache=TRUE}
Y <- psc_sne(X=x_array, d=2, rho_psc_list = rho_first_20, num_iteration=125,
             colors=rep(c(1,2), each=nrow(x_array)/2), visualize_prog = TRUE, eta=100)
```

```{r rgl=TRUE, dev='png', fig.align='center'}
rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "gray",
             lit = FALSE)
rgl::points3d(Y[,,127], col = rep(c(1,2), each=nrow(x_array)/2))
```

```{r}
scatterplot3d::scatterplot3d(Y[,,127],
                                 xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
                                 color = rep(c(1,2), each=nrow(x_array)/2))
```

It's clearly clustered the two groups we had in the original generated data.

### Case 2

Sample on the $(\mathbb{S}^2)^2$ where $p=2$ and $r=2$.


```{r pressure, echo=FALSE}
n=200
d=2
r=2
set.seed(100469000)
samp1 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = 0, ph = 0.5)),
                        kappa = 50)
set.seed(100469000)
samp2 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = 2, ph = -1.5)),
                        kappa = 50)
set.seed(100469000)
samp3 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = -1, ph = 0)),
                        kappa = 50)
x1 <- rbind(samp1, samp2, samp3)

scatterplot3d::scatterplot3d(x1,
                             xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
                             color = rep(1:3, each = n), main="Sphere 1")

rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(x1, col = rep(c(1,2,3), each=n))

set.seed(100469000)
samp4 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = 0, ph = 0.55)),
                        kappa = 60)
set.seed(100469000)
samp5 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = 2, ph = -1.41)),
                        kappa = 60)
set.seed(100469000)
samp6 <- rotasym::r_vMF(n = n, mu = drop(DirStats::to_sph(th = -1.1, ph = 0.05)),
                        kappa = 60)
x2 <- rbind(samp4, samp5, samp6)

scatterplot3d::scatterplot3d(x2,
                             xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
                             color = rep(1:3, each = n), main="Sphere 2")
rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(x2, col = rep(c(1,2,3), each=n))


x_2 <- array(dim = c(n*3, 3, 2))
x_2[, , 1] <- x1
x_2[, , 2] <- x2
n <- 600
```

Let's calculate the rho parameters based on a perplexity of 20:

```{r cache=TRUE}
rho_second_perp20 <- rho_optim_parallel(x_2, 20)
```

First, let's reduce to dimension $\mathbb{S}^1$ then $d=1$ (circumference):

```{r cache=TRUE}
Y <- psc_sne(X=x_2, d=1, rho_psc_list = rho_second_perp20, num_iteration=250, eta=75,
             colors=rep(c(1,2,3), each=n/3), visualize_prog = TRUE)
```

```{r}
Y_rad <- DirStats::to_rad(Y[,,252])
r <- 1
theta <<- Y_rad
plot(r*sin(theta),
     r*cos(theta),
     col=rep(c(1,2,3), each=n/3),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now we are going to reduce to dimension $\mathbb{S}^2$ then $d=2$ (sphere):

```{r cache=TRUE}
Y <- psc_sne(X=x_2, d=2, rho_psc_list = rho_second_perp20, num_iteration=250, eta=75,
             colors=rep(c(1,2,3), each=n/3), visualize_prog = TRUE)
```

```{r rgl=TRUE, dev='png', fig.align='center'}
rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "gray",
             lit = FALSE)
rgl::points3d(Y[,,252], col = rep(c(1,2), each=nrow(Y)/2))

```

```{r}
scatterplot3d::scatterplot3d(Y[,,252],xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1), 
                             color = rep(c(1,2,3), each=n/3))
```

It's clearly clustered the three groups we had in the original generated data.
