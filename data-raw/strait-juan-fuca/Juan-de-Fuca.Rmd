---
title: "San Juan de Fuca"
author: "Luis Ángel Rodríguez García"
date: "25-05-2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = rprojroot::find_rstudio_root_file())
library(rprojroot)
library(here)
library(knitr)
library(rgl)
rgl::setupKnitr()
library(ncdf4)
library(lubridate)
library(circular)
library(dplyr)
library(abind)
library(tidyr)
library(pscsne)
```

```{r}
juanfuca_pkg <-  paste(here("data-raw", "strait-juan-fuca"), "jdf.rda", sep = "/")
load(juanfuca_pkg)
```

Transform the original data set into an array of dimension `c(n, d+1, r)`, where `n` is the time instant, `r` is the number of (latitude and longitude) coordinates and `d+1` are the Cartesian angles which in this cases is equal to 2. 

```{r}
# Obtain other data frame
# Transform into coordinates (value formed by lat and lon separated by a comma)
# Remove speed from the dataset
jdf_coor <- jdf_long_fmt %>% 
  unite(col = "coordinates", lat, lon, sep = ",") %>% 
  select(-speed)
# Transform the data frame into a 3-dimensional array
jdf_coor <- abind(split(jdf_coor, jdf_coor$coordinates), along = 3)

# Sum the number of NA's by each row
to_remove <- colSums(t(sapply(1:dim(jdf_coor)[3], function(k) is.na(jdf_coor[ , 3, k]))))
# Indexes of the rows without NA's
index_to_remove <- to_remove == 0

# Select only those rows without NA's
jdf_coor <- jdf_coor[index_to_remove , , ]

# Calculate the Cartesian angles
jdf_pscsne <- sapply(1:dim(jdf_coor)[3], function(k) DirStats::to_cir(as.numeric(jdf_coor[ , 3, k])), simplify = 'array')

# Save dataset in long format
save(
  list = "jdf_pscsne",
  file = paste(here("data-raw", "strait-juan-fuca"), "pscsne.rda", sep = "/")
)

# Remove all objects
rm(list = ls())
gc()

# Loading the psc-sne input object
load(paste(here("data-raw", "strait-juan-fuca"), "pscsne.rda", sep = "/"))

```

Let's calculate some rho values for a perplexity of 12, 20, 33 and 45.

```{r cache=TRUE}

# rho_12 <- rep(.5, nrow(jdf_pscsne))
# rho_12 <- rho_optim_bst(sanjuanfuca, 12)
rho_25 <- rho_optim_bst(jdf_pscsne, 25)
# rho_33 <- rho_optim_bst(sanjuanfuca, 33)
# rho_45 <- rho_optim_bst(sanjuanfuca, 45)

```

```{r}

load(paste(here("data-raw", "strait-juan-fuca"), "pscsne.rda", sep = "/"))

rho_point5 <- rep(0.5, nrow(jdf_pscsne))
high_dimension(x = jdf_pscsne, rho_list = rho_point5)


```

Let's reduce the dimension using the polyspherical Cauchy SNE. First, optimized rho for a perplexity of 12 and $d=1$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=1, 
             rho_psc_list = rho, 
             num_iteration=300)
```

```{r fig.asp=1}
Y_rad <- DirStats::to_rad(Y)
r <- 1
theta <<- Y_rad
plot(r*sin(theta),
     r*cos(theta),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, optimized rho for a perplexity of 12 and $d=2$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=2, 
             rho_psc_list = rho_12, 
             num_iteration=300)
```

```{r}
scatterplot3d::scatterplot3d(Y, xlim = c(-1, 1), ylim = c(-1, 1), 
                             zlim = c(-1, 1), color = rep(1, nrow(Y)))

rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(Y, col = rep(1, nrow(Y)))
```
Now, optimized rho for a perplexity of 20 and $d=1$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=1, 
             rho_psc_list = rho_20, 
             num_iteration=300)
```

```{r fig.asp=1}
Y_rad <- DirStats::to_rad(Y)
r <- 1
theta <<- Y_rad
plot(r*sin(theta),
     r*cos(theta),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, optimized rho for a perplexity of 12 and $d=2$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=2, 
             rho_psc_list = rho_12, 
             num_iteration=300)
```

```{r}
scatterplot3d::scatterplot3d(Y, xlim = c(-1, 1), ylim = c(-1, 1), 
                             zlim = c(-1, 1), color = rep(1, nrow(Y)))

rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(Y, col = rep(1, nrow(Y)))
```

Now, optimized rho for a perplexity of 33 and $d=1$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=1, 
             rho_psc_list = rho_33, 
             num_iteration=300)
```

```{r fig.asp=1}
Y_rad <- DirStats::to_rad(Y)
r <- 1
theta <<- Y_rad
plot(r*sin(theta),
     r*cos(theta),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, optimized rho for a perplexity of 33 and $d=2$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=2, 
             rho_psc_list = rho_33, 
             num_iteration=300)
```

```{r}
scatterplot3d::scatterplot3d(Y, xlim = c(-1, 1), ylim = c(-1, 1), 
                             zlim = c(-1, 1), color = rep(1, nrow(Y)))

rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(Y, col = rep(1, nrow(Y)))
```

Lastly, optimized rho for a perplexity of 45 and $d=1$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=1, 
             rho_psc_list = rho_45, 
             num_iteration=300)
```

```{r fig.asp=1}
Y_rad <- DirStats::to_rad(Y)
r <- 1
theta <<- Y_rad
plot(r*sin(theta),
     r*cos(theta),
     xlim=c(-max(r),max(r)),
     ylim=c(-max(r),max(r)))

polygon(max(r)*sin(seq(0,2*pi,length.out=100)),max(r)*cos(seq(0,2*pi,length.out=100)))
```

Now, optimized rho for a perplexity of 33 and $d=2$:

```{r cache=TRUE}
Y <- psc_sne(X=jdf_pscsne, d=2, 
             rho_psc_list = rho_45, 
             num_iteration=300)
```

```{r}
scatterplot3d::scatterplot3d(Y, xlim = c(-1, 1), ylim = c(-1, 1), 
                             zlim = c(-1, 1), color = rep(1, nrow(Y)))

rgl::plot3d(0, 0, 0, xlim = c(-1, 1), ylim = c(-1, 1), zlim = c(-1, 1),
             radius = 1, type = "s", col = "lightblue", alpha = 0.25,
             lit = FALSE)
rgl::points3d(Y, col = rep(1, nrow(Y)))
```
